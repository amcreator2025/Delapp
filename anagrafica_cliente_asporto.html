<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Anagrafica Cliente – Asporto</title>
 <style>
    /* Mantieni palette/stile dell'app */
    :root{
      --brand-dark:#004d40; --brand:#00796b; --brand-hover:#005f56;
      --bg:#fafafa; --card:#fff; --text:#333;
      --border:#d1d5db; --muted:#6b7280; --ring:0 0 0 3px rgba(0,121,107,.15);
      --shadow:0 8px 24px rgba(0,0,0,.10); --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:'Segoe UI', system-ui, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text);}
    a{color:var(--brand-dark); text-decoration:none}
    .bg-pattern{position:fixed; inset:0; pointer-events:none; z-index:-1; background:
      radial-gradient(1000px 500px at 80% -20%, rgba(0,121,107,.06), transparent 60%),
      radial-gradient(800px 450px at -10% 110%, rgba(0,77,64,.06), transparent 60%),
      linear-gradient(180deg,#fff 0%, #f6f8f9 100%);}
    header.app{background:var(--brand-dark); color:#fff; padding:1rem; position:sticky; top:0; z-index:10}
    header.app .wrap{max-width:820px; margin:0 auto; display:flex; align-items:center; gap:12px}
    .logo{width:44px; height:44px; border-radius:12px; background:#fff; color:var(--brand-dark); display:grid; place-items:center; font-weight:800; border:1px solid #e6e6e6}
    h1.title{margin:0; font-size:1.15rem}
    .subtitle{margin:.2rem 0 0; opacity:.9; font-size:.9rem; color:#e5f6f4}
    main{padding:1.25rem; max-width:820px; margin:0 auto}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .card header{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:14px 16px; border-bottom:1px solid var(--border)}
    .chip{display:inline-flex; align-items:center; gap:.4rem; background:#e0f2f1; color:var(--brand-dark); padding:.3rem .7rem; border-radius:999px; font-size:.82rem; border:1px solid #cce8e5}
    .card .content{padding:16px}
    .help{margin:0 0 10px; color:var(--muted); font-size:.92rem}
    /* Form grid */
    form{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .wide{grid-column:1 / -1}
    .field label{display:flex; justify-content:space-between; align-items:center; font-weight:700; font-size:.9rem; margin-bottom:.35rem; color:#374151}
    .right-hint{font-weight:500; color:#64748b; font-size:.8rem}
    .input-wrap{position:relative}
    .input-wrap svg{position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.6}
    input{width:100%; padding:.75rem .85rem .75rem 40px; border:1px solid var(--border); border-radius:12px; font-size:1rem; transition:border .15s, box-shadow .15s}
    input:focus{outline:none; border-color:var(--brand); box-shadow:var(--ring)}
    .err{display:none; margin-top:6px; font-size:.82rem; color:#b91c1c}
    .field.invalid .err{display:block}
    .field.invalid input{border-color:#ef4444}
    /* Footer azioni */
    .actions{display:flex; gap:.6rem; justify-content:flex-end; flex-wrap:wrap; margin-top:10px}
    .btn{background:var(--brand); color:#fff; border:none; padding:.7rem 1rem; border-radius:12px; cursor:pointer; transition:background .2s, transform .04s}
    .btn:hover{background:var(--brand-hover)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#fff; color:var(--brand-dark); border:1px solid #cbd5d6}
    /* Toast */
    #toast{position:fixed; bottom:16px; right:16px; background:#111; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; transform:translateY(8px); transition:.2s; z-index:100}
    #toast.show{opacity:1; transform:none}
    /* Responsive */
    @media (max-width:720px){ form{grid-template-columns:1fr} }
    @media print{ header.app,.actions,#toast{display:none} .card{box-shadow:none} }
  </style>
</head>
<body>
  <div class="bg-pattern" aria-hidden="true"></div>
  <header class="app">
    <div class="wrap">
      <div class="logo">R</div>
      <div>
        <h1 class="title">Anagrafica Cliente (Asporto)</h1>
        <p class="subtitle">Inserisci i dati essenziali per il ritiro</p>
      </div>
    </div>
  </header>

  <main>
    <section class="card" role="form" aria-labelledby="formTitle">
      <header>
        <h2 id="formTitle" style="margin:0; font-size:1rem; color:#0b3b35">Dati per l'asporto</h2>
        <span class="chip">Modalità: Asporto</span>
      </header>
      <div class="content">
        <p class="help">Per l'asporto non sono richiesti indirizzo e CAP.</p>

        <form id="anagraficaForm" novalidate>
          <div class="field" id="f-nome">
            <label for="nome">Nome</label>
            <div class="input-wrap">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4zm0 2c-3.3 0-6 2.7-6 6h12c0-3.3-2.7-6-6-6z" fill="#64748b"/></svg>
              <input type="text" id="nome" required autocomplete="given-name" placeholder="Es. Mario"/>
            </div>
            <div class="err">Inserisci il nome.</div>
          </div>

          <div class="field" id="f-cognome">
            <label for="cognome">Cognome</label>
            <div class="input-wrap">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4zm0 2c-3.3 0-6 2.7-6 6h12c0-3.3-2.7-6-6-6z" fill="#64748b"/></svg>
              <input type="text" id="cognome" required autocomplete="family-name" placeholder="Es. Rossi"/>
            </div>
            <div class="err">Inserisci il cognome.</div>
          </div>

          <div class="field wide" id="f-telefono">
            <label for="telefono">Telefono <span class="right-hint">solo cifre</span></label>
            <div class="input-wrap">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6.6 10.2c1.2 2.4 3.1 4.3 5.5 5.5l2-2c.3-.3.8-.4 1.1-.2 1 .3 2 .5 3.1 .5.6 0 1 .4 1 .9v3.4c0 .6-.4 1-1 1C10.5 19.3 4.7 13.5 4.7 6.6c0-.6.4-1 .9-1H9c.5 0 .9 .4 .9 1 0 1.1 .2 2.1 .5 3.1 .1 .4 0 .8 -.3 1.1l-1.5 1.4z" fill="#64748b"/></svg>
              <input type="tel" id="telefono" required inputmode="numeric" autocomplete="tel" placeholder="Es. 3331234567" pattern="\d{9,12}"/>
            </div>
            <div class="err">Inserisci un numero valido (9–12 cifre).</div>
          </div>

          <div class="field wide" id="f-email">
            <label for="email">Email <span class="right-hint">facoltativa</span></label>
            <div class="input-wrap">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M20 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2zm-1.4 3L12 11 5.4 7H18.6z" fill="#64748b"/></svg>
              <input type="email" id="email" autocomplete="email" placeholder="es. mario.rossi@mail.it"/>
            </div>
            <div class="err">Inserisci un'email valida.</div>
          </div>

          <div class="actions wide">
            <button type="button" class="btn secondary" id="btnBack">← Indietro</button>
            <button type="submit" class="btn" id="btnSubmit">Prosegui con l'ordine</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <div id="toast" role="status" aria-live="polite"></div>
  <!-- Invio ordine (asporto) a Supabase + compatibilità conferma -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    // ⬇⬇⬇ INSERISCI QUI LE TUE CHIAVI ⬇⬇⬇
   const SUPABASE_URL = "https://svulhysmqimrkxlregyy.supabase.co"; // <- metti il tuo
   const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2dWxoeXNtcWltcmt4bHJlZ3l5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNjYzNTUsImV4cCI6MjA3MTY0MjM1NX0.7AdMQITbKawLMLXUf2a4AnSGNNKB7lzel2fJ6-LzHYo";               // <- metti il tuo
   const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const fmtNum = s => Number(String(s).replace('€','').replace(',','.').trim()) || 0;
    function parseRiga(line){
      const str = String(line);
      let name = str, qty = 1, price = 0;
      const xIdx = str.toLowerCase().lastIndexOf(' x');
      if (xIdx > 0) {
        const q = parseInt(str.slice(xIdx+2), 10);
        if (!isNaN(q)) qty = q;
        name = str.slice(0, xIdx).trim();
      }
      const m = str.match(/([\d]+[.,]?[\d]*)\s*€/);
      if (m) price = fmtNum(m[1]);
      return { name, qty, price };
    }
    async function creaOrdineSupabase(payload){
      const { data, error } = await supabase.from('orders').insert([payload]).select('*').single();
      if (error) throw error; return data;
    }

    const form = document.getElementById("anagraficaForm");
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const nome = form.nome.value.trim();
      const cognome = form.cognome.value.trim();
      const telefono = form.telefono.value.trim();
      const email = (form.email?.value || '').trim();

      if (!nome || !cognome || !telefono) {
        alert("Compila nome, cognome e telefono.");
        return;
      }

      // Dati dallo shopping flow
      const ordineCorrente = JSON.parse(localStorage.getItem("ordineCorrente") || "{}");
      const righe = Array.isArray(ordineCorrente.piatti) ? ordineCorrente.piatti : []; // ["Prod x2 — 7.50€", ...]
      const items = righe.map(parseRiga);
      const total = items.reduce((s,i)=> s + (i.price * (i.qty || 1)), 0);
      const slot_label = ordineCorrente.orario || localStorage.getItem("orario_scelto") || "Orario non specificato";
      const payment_method = (localStorage.getItem("pagamento_scelto") || "cash").toLowerCase();

      // Payload per DB
      const payload = {
        type: 'pickup',
        status: 'pending',
        placed_at: new Date().toISOString(),
        slot_label,
        customer_name: `${nome} ${cognome}`.trim(),
        customer_phone: telefono,
        items,
        notes: '',
        payment_method,
        total
      };

      const btnSubmit = document.getElementById("btnSubmit");
      try{
        btnSubmit.disabled = true; btnSubmit.textContent = "Invio…";
        const created = await creaOrdineSupabase(payload);

        // Aggiorna pendingOrders per conferma_ordine.html
        const pending = JSON.parse(localStorage.getItem('pendingOrders') || '[]');
        pending.push({
          id: created.id,
          cliente: payload.customer_name,
          telefono: payload.customer_phone,
          modalita: 'asporto',
          indirizzo: 'Ritiro al locale',
          orario: slot_label,
          pagamento: payment_method,
          totale: total,
          dettagli: righe
        });
        localStorage.setItem('pendingOrders', JSON.stringify(pending));

        localStorage.removeItem('cartSelezione');
        window.location.href = 'conferma_ordine.html';
      }catch(err){
        console.error(err);
        alert("Errore nell'invio dell'ordine: " + (err.message || err));
      }finally{
        btnSubmit.disabled = false; btnSubmit.textContent = "Prosegui con l’ordine";
      }
    });

    // pulizia eventuale hash del magic link
    if (window.location.hash.includes('access_token')) {
      history.replaceState({}, document.title, window.location.pathname);
    }
  </script>
</body>
</html>
